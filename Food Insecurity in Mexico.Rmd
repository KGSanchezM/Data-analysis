---
title: "Food insecurity in Mexico"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Supposing a nutritional health cent  er is interested in the statistical analysis of the patterns of expenditure on healthy and unhealthy foods in Mexican households based on their socioeconomic level, whether the household has additional financial resources beyond income, and whether it experiences food insecurity or not. 

The database is an extract from the National Health and Nutrition Survey (2012) conducted by the National Institute of Public Health in Mexico. The majority of individuals affirm that households with lower socioeconomic levels tend to spend more on unhealthy products compared to those with higher socioeconomic levels, and that this, among other determinants, leads to a certain level of food insecurity in a household.

The database contains the following variables:

- `nse5f` (Household socioeconomic level):
  - 1: "Low"
  - 2: "Lower-middle"
  - 3: "Middle"
  - 4: "Upper-middle"
  - 5: "High"

- `area` (Geographic area):
  - 0: "Urban area"
  - 1: "Rural area"

- `numpeho` (Number of individuals in the household)

- `refin` (Financial resources other than labor income):
  - 0: "No"
  - 1: "Yes"

- `edadjef` (Age of the head of the family)

- `sexoje` (Sex of the head of the family):
  - 0: "Male"
  - 1: "Female"

- `añosedu` (Years of education of the head of the family)

- `ln_als` (Natural logarithm of expenditure on healthy foods)

- `ln_alns` (Natural logarithm of expenditure on unhealthy foods)

- `IA` (Food insecurity in the household):
  - 0: "Does not present food insecurity"
  - 1: "Presents food insecurity"

First, I will import the libraries and the dataset for the project. I would like to express my gratitude to BEDU for the assistance provided in this project and for providing the database.



```{r message=FALSE, warning=FALSE}
library(dplyr)
library(DescTools)
library(ggplot2)
library(moments)
library(vioplot)
library(caret)


df <- read.csv("https://raw.githubusercontent.com/beduExpert/Programacion-R-Santander-2022/main/Sesion-08/Postwork/inseguridad_alimentaria_bedu.csv")

head(df,n=5)

```


#### Cleaning the data and converting the data types

```{r}
df2<-na.omit(df) # Cleaning N/A
str(df2)
```

There are categorical variables, they are going to be converted into factors.

```{r}
df2$nse5f<-factor(df2$nse5f,labels = c("Low","Lower-middle","Middle","Upper-middle","High"),ordered = TRUE)
df2$area <-factor(df2$area,labels  = c("Urban area","Rural area"))
df2$refin <-factor(df2$refin,labels =   c("No","Yes"))
df2$sexojef<-factor(df2$sexojef,labels =   c("Male ","Female"))
df2$IA <- factor(df2$IA,labels =   c("No","Yes"))

```

##### Exploratory Data Analysis (EDA)

A statistical summary will be presented.
 
```{r}
summary(df2)
```

Visualizing the distribution of the data is important to understand and identify atypical values.

```{r}
# For numeric columns only
df_numeric <- df2[, sapply(df2, is.numeric)]

# Set layout to 3 rows and 4 columns
par(mfrow = c(3, 4))

# Loop through each column in df_numeric
for (col in colnames(df_numeric)) {
  # Create violin plot for each variable
  vioplot(df_numeric[[col]], main = paste("Violin Plot of", col),
          xlab = col, ylab = "Value", col = "steelblue", border = "black")

  # Create box plot for each variable
  boxplot(df_numeric[[col]], main = paste("Box Plot of", col),
          xlab = col, ylab = "Value", col = "steelblue", border = "black")
  
  # Calculate the mean of the variable
  mean_val <- mean(df_numeric[[col]])
  
  # Add a red line representing the mean
  abline(h = mean_val, col = "red", lwd = 2)
}




```



- For "numpeho" (number of individuals per home), the majority of homes have less than 10 people. For this variable, the top 10% of the data will be removed.

- For "edadjef" (age of the head of the family), "añosedu" (years of education of the head of the family), and "ln_alns" (natural logarithm of expenditure on unhealthy foods), it won't be applied any kind of transformation because there aren't many atypical points.

- For "ln_als" (natural logarithm of expenditure on healthy foods), there are many atypical values at the upper end of the distribution. To address this, the top 10% of the data will be removed.

```{r}
# Calculate the 95th percentile for the numpeho and ln_als columns
percentile_90 <- quantile(df2$numpeho, 0.9)
df2$numpeho <- ifelse(df2$numpeho > percentile_90, percentile_90, df2$numpeho)

percentile_90_ln_als <- quantile(df2$ln_als, 0.90)
df2$ln_als <- ifelse(df2$ln_als > percentile_90_ln_als, percentile_90_ln_als, df2$ln_als)


```

For the categorical variables, bar graphs will be used to visualize the number of counts for each category.

```{r message=FALSE, warning=FALSE}
# Get the categorical columns of the df2 dataframe
df_categorical <- df2[, sapply(df2, is.factor)]

# Set layout to 2 rows and 3 columns
par(mfrow = c(2, 3))

# Iterate over each categorical column and generate the bar plot
for (col in colnames(df_categorical)) {
  # Calculate the frequencies of each category
  frequencies <- table(df_categorical[[col]])

  # Create the bar plot with custom formatting
  barplot(frequencies, main = col,
          xlab = col, ylab = "Frequency",
          col = "steelblue",  # Set the color of the bars
          border = "white",   # Set the color of the bar border
          cex.names = 1.1     # Adjust the size of x-axis labels
  )
}


```

##### Hypothesis Testing

Let's test the hypothesis that a higher socioeconomic level is associated with a higher average expenditure on healthy food.

Ho: prom_lnals_nsef5hight <= prom_lnals_nsef5Low
Ha: prom_lnals_nsef5hight > prom_lnals_nsef5Low

Ho: The average expenditure on healthy food for individuals with high socioeconomic level is less than or equal to the average expenditure on healthy food for individuals with low socioeconomic level.

Ha: The average expenditure on healthy food for individuals with high socioeconomic level is greater than the average expenditure on healthy food for individuals with low socioeconomic level.

```{r}

#Checking if the variances are equal.
var.test(df2[df2$nse5f == "High", "ln_als"], 
         df[df2$nse5f == "Low", "ln_als"], 
         ratio = 1, alternative = "two.sided")
```

p <= 0.05, the variances are considered different with a 95% confidence level.

```{r}
t.test(x = df2[df2$nse5f == "High", "ln_als"], 
       y = df2[df2$nse5f == "Low", "ln_als"],
       alternative = "greater",
       mu = 0, var.equal = FALSE)
```

p < 0.05

For a 95% confidence level, the average expenditure on healthy food for individuals with a high socioeconomic level is greater than the average expenditure on healthy food for individuals with a low socioeconomic level.


#### Prediction of food insecurity

To predict food insecurity in households a logistic regression will be used

```{r}
# Set the seed for reproducibility
set.seed(2023)

# Divide the dataset into training and testing sets
train_indices <- createDataPartition(df2$IA, p = 0.7, list = FALSE)
train_data <- df2[train_indices, ]
test_data <- df2[-train_indices, ]

#Defining the independent variable
y_train <- train_data$IA
x_train <- train_data[, !(names(train_data) %in% c("IA"))]

y_test <- test_data$IA
x_test <- test_data[, !(names(test_data) %in% c("IA"))]

```

Defining the model 

```{r}
model <- glm(y_train ~ ., data = x_train, family = binomial)
predictions <- predict(model, newdata = x_test, type = "response")

predictions <- ifelse(predictions >= 0.5, 1, 0)
predictions <- factor(predictions,labels =   c("No","Yes"))

#Evaluating the model

confusion_matrix <- confusionMatrix(predictions, reference = y_test)
accuracy <- confusion_matrix$overall["Accuracy"]
sensitivity <- confusion_matrix$byClass["Sensitivity"]
specificity <- confusion_matrix$byClass["Specificity"]

print(accuracy)
print(sensitivity)
print(specificity)




```



For this model, we are able to predict 93.3% of the houses that don't have food insecurity, but only 26.4% that actually do.



